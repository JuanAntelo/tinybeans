<html>
<head>
	<base href="/">
	<link rel="stylesheet" href="styles.css"/>
	<link rel="stylesheet" href="semantic.min.css"/>
	<link rel="stylesheet" href="semantic.min.js"/>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.7.9/angular.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular-route.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.0/jquery.min.js"></script>
</head>
<body ng-app="myApp">

<div ng-view></div>

<script>

// PollDetail submit & server side part
// PollResults
// CreatePoll

var app = angular.module("myApp", ["ngRoute"]);

app.constant('AppConstants', {
    baseUrl: 'http://localhost:3000/'
});

app.controller('PollResults',function($scope, $location){
	$http.post('/pollById', { ID: $routeParams.id }).then(function(res){
		$scope.poll = res.data.poll;
	}, function(req, res){
		console.log('Error occured while calling pollsByUser')
	});
});

app.controller('PollDetail',function($scope, $location, $http, CurrentPoll, $routeParams){
	$scope.sumbitPoll = function() {
		$http.post('/submitPollAnswerById', { ID: $routeParams.id }).then(function(res){
			$location.url('/results/' + $routeParams.id );
		}, function(req, res){
			console.log('Error occured while calling pollsByUser')
		});
	}

	$scope.back = function() {
		$location.url('/dashboard');
	}

	$http.post('/pollById', { ID: $routeParams.id }).then(function(res){
		$scope.poll = res.data[0];
	}, function(req, res){
		console.log('Error occured while calling pollsByUser')
	});
});

app.controller('CreatePoll',function($scope, $location){
	$scope.createPoll = function() {
		$scope.answerA = $("#");
		$scope.answerB = $("#");
		$scope.answerC = $("#");
		$scope.answerD = $("#");
		$scope.answerE = $("#");

		$http.post('/createPoll', {
			"pollName":"",
			"answerA":"",
			"answerB":"",
			"answerC":"",
			"answerD":"",
			"answerE":"",
			"answerACount": 0,
			"answerBCount": 0,
			"answerCCount": 0,
			"answerDCount": 0,
			"answerECount":""
		}).then(function(){
			$location.url('/dashboard');
		}, function(){
			console.log('Error occured during CreatePoll')
		});
	}
});

app.controller('Dashboard',function($scope, $location, $http, CurrentUser) {
	$scope.availablePolls = [];
	$scope.completedPolls = [];

	$scope.goToCreatePoll = function() {
		$location.url('/admin');
	}

	$scope.navigateToPoll = function(poll) {
		$location.url('/question/' + poll.ID);
	}

	$scope.navigateToResults = function(poll) {
		$location.url('/results/' + poll.ID);
	}
	
	$scope.availablePolls = [];
	$scope.completedPolls = [];

	$http.post('/pollsByUser', {username: CurrentUser.get()}).then(function(res){
		$scope.availablePolls = res.data.availablePolls;
		$scope.completedPolls = res.data.completedPolls;
	}, function(req, res){
		console.log('Error occured while calling pollsByUser')
	});
});

app.factory('CurrentUser', function() {
	var user = "";
	return {
		set: function(username){
			user = username;
			return user;
		},
		get: function(){
			return user;
		}
	}
})

app.factory('CurrentPoll', function() {
	var pollID = "";
	return {
		set: function(poll){
			pollID = poll;
			return pollID;
		},
		get: function(){
			return pollID;
		}
	}
})

app.controller('Auth',function($scope, $location, $http, AppConstants, CurrentUser){
	$scope.error = false;

	$scope.login = function() {
		var username = $("#username").val();
		var password = $("#password").val();
		$http.post('/login', {
			'username': username,
			'password': password,
		}).then(function(res){
			if(res.data === 'empty') {
				$scope.error = true;
			} else {
				CurrentUser.set(username);
				$location.url('/dashboard');				
			}
		}, function(){
			console.log('Server error occured')
		});
	}

	$scope.goToLogin = function() {
		$location.url('/');
	}

	$scope.goToSignup = function() {
		$location.url('/signup');
	}

	$scope.signup = function() {
		$scope.error = false;
		var username = 			$("#signup-username").val();
		var password = 			$("#signup-password").val();
		var reenterPassword = 	$("#signup-reenterpassword").val();

		var validationCheck = false;
		if(username && password && reenterPassword) {
			if(password === reenterPassword) {
				validationCheck = true;
			}
		}

		if(!validationCheck) {
			$scope.error = true;
			return;
		}

		$http.post('/signup', {
			'username': username,
			'password': password
		}).then(function(response) {
			if(response !== "failed") {
				$location.url('/');
			} else {
				console.log('unable to sign up. try again')
			}
		}, function(){
			console.log('Error occured during log in')
		});
	}
})

app.config(function($routeProvider,$locationProvider) {
  $routeProvider
  .when("/", {
    templateUrl : "/templates/login.html",
    controller: 'Auth'
  })
  .when("/signup", {
    templateUrl : "/templates/signup.html",
    controller: 'Auth'
  })
  .when("/dashboard", {
    templateUrl : "/templates/main.html",
    controller: 'Dashboard'
  })
  //
  .when("/question/:id", {
    templateUrl : "/templates/polldetail.html",
    controller: 'PollDetail'
  })
  //
  .when("/results/:id", {
    templateUrl : "/templates/pollresults.html",
    controller: 'PollResults'
  })
  .when("/admin", {
    templateUrl : "/templates/create.html",
    controller: 'CreatePoll'
  });
  $locationProvider.html5Mode(true);
});

</script>

</body>
</html>
